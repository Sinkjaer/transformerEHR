{
  "cells": [
    {
      "cell_type": "code",
      "source": [
        "import sys\n",
        "\n",
        "sys.path.insert(0, \"../\")\n",
        "\n",
        "Azure = True\n",
        "\n",
        "import json\n",
        "from torch.utils.data import DataLoader\n",
        "\n",
        "from dataLoader.dataLoaderMLM import CoercionRiskDataset, process_data_CoercionRisk\n",
        "from dataLoader.build_vocab import load_vocab, build_vocab"
      ],
      "outputs": [],
      "execution_count": 1,
      "metadata": {
        "gather": {
          "logged": 1690626114756
        }
      }
    },
    {
      "cell_type": "code",
      "source": [
        "if Azure:\n",
        "    file_config = {\n",
        "        \"vocab\": \"../dataloader/vocab.txt\",  # vocabulary idx2token, token2idx\n",
        "        \"data_train\": \"../../EHR_data/data/fine_tune_training_set.json\",  # formated data\n",
        "        \"data_val\": \"../../EHR_data/CoercionData_val.json\",  # formated data\n",
        "        \"model_path\": \"model/model1/\",  # where to save model\n",
        "        \"model_name\": \"test\",  # model name\n",
        "        \"file_name\": \"log\",  # log path\n",
        "        \"use_cuda\": True,\n",
        "        \"device$\": \"cuda:0\",\n",
        "    }\n",
        "else:\n",
        "    file_config = {\n",
        "        \"vocab\": \"/Users/mikkelsinkjaer/Library/Mobile Documents/com~apple~CloudDocs/transEHR/Code/transformerEHR/data/vocab.txt\",  # vocabulary idx2token, token2idx\n",
        "        \"data_train\": \"/Users/mikkelsinkjaer/Library/Mobile Documents/com~apple~CloudDocs/transEHR/Code/transformerEHR/data/syntheticData.json\",\n",
        "        \"data_val\": \"/Users/mikkelsinkjaer/Library/Mobile Documents/com~apple~CloudDocs/transEHR/Code/transformerEHR/data/syntheticData_val.json\",\n",
        "        \"model_path\": \"model/model1/\",  # where to save model\n",
        "        \"model_name\": \"test\",  # model name\n",
        "        \"file_name\": \"log.txt\",  # log path\n",
        "        \"use_cuda\": False,\n",
        "        \"device\": \"cpu\",\n",
        "    }"
      ],
      "outputs": [],
      "execution_count": 2,
      "metadata": {
        "gather": {
          "logged": 1690626114881
        }
      }
    },
    {
      "cell_type": "code",
      "source": [
        "with open(file_config[\"data_train\"]) as f:\n",
        "    data_json = json.load(f)\n",
        "print(next(iter(data_json.items())))\n",
        "vocab_list, word_to_idx = build_vocab(data_json, Azure=Azure)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "('304868', {'Sex': 'Kvinde', 'BirthDate': '1962-12-22', 'DeathDate': None, 'Events': [{'EncounterKey': 102264811, 'Time': '2020-10-09T11:00:00', 'Type': 'Aftale'}, {'EncounterKey': 111163862, 'Time': '2021-04-15T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 106902509, 'Time': '2020-12-03T11:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111183166, 'Time': '2021-03-04T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 111117620, 'Time': '2021-03-25T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 105505619, 'Time': '2020-11-18T09:30:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106674851, 'Time': '2021-02-02T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 102676917, 'Time': '2020-10-09T14:15:00', 'Type': 'Aftale'}, {'EncounterKey': 105543808, 'Time': '2020-11-10T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106914332, 'Time': '2020-11-27T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 102720906, 'Time': '2020-11-05T13:15:00', 'Type': 'Behandlingskontakt'}, {'EncounterKey': 102803602, 'Time': '2020-11-05T13:15:00', 'Type': 'Aftale'}, {'EncounterKey': 102736688, 'Time': '2020-11-05T13:15:00', 'Type': 'Aftale'}, {'EncounterKey': 107970818, 'Time': '2020-12-15T12:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106702172, 'Time': '2020-12-15T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111120177, 'Time': '2021-02-11T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 112094929, 'Time': '2021-02-23T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111154120, 'Time': '2021-01-28T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111410769, 'Time': '2021-02-23T12:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111175815, 'Time': '2021-02-04T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 99937139, 'Time': '2020-09-06T00:00:00', 'Type': 'Behandlingskontakt'}, {'EncounterKey': 130452149, 'Time': '2021-09-25T13:05:00', 'Type': 'Behandlingskontakt'}, {'EncounterKey': 112100130, 'Time': '2021-03-02T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 102651307, 'Time': '2020-11-10T13:00:00', 'Type': 'Aftale'}, {'EncounterKey': 103713334, 'Time': '2020-10-30T09:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 104314369, 'Time': '2020-11-05T11:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 107798724, 'Time': '2020-12-11T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 105702819, 'Time': '2020-11-20T09:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 105573406, 'Time': '2020-11-17T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 104512451, 'Time': '2020-11-06T09:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 102562853, 'Time': '2020-10-20T12:30:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 104107768, 'Time': '2020-10-27T11:30:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 114153773, 'Time': '2021-03-09T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 102742914, 'Time': '2020-11-05T13:15:00', 'Type': 'Aftale'}, {'EncounterKey': 1592171, 'Time': '2017-09-04T15:15:00', 'Type': 'Behandlingskontakt'}, {'EncounterKey': 102620759, 'Time': '2020-10-09T14:15:00', 'Type': 'Aftale'}, {'EncounterKey': 111192552, 'Time': '2021-02-18T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 115329825, 'Time': '2021-03-23T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106662789, 'Time': '2021-02-16T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 106656612, 'Time': '2021-01-12T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111155169, 'Time': '2021-04-08T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 102679604, 'Time': '2020-10-09T14:15:00', 'Type': 'Aftale'}, {'EncounterKey': 109332593, 'Time': '2021-01-12T12:30:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106706377, 'Time': '2020-12-22T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111164118, 'Time': '2021-03-18T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 106650668, 'Time': '2021-01-26T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106656474, 'Time': '2021-01-19T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106651705, 'Time': '2021-01-05T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 105612793, 'Time': '2020-11-19T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 99937698, 'Time': '2020-09-06T15:25:00', 'Type': 'Behandlingskontakt'}, {'EncounterKey': 110487271, 'Time': '2021-01-19T12:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 103646158, 'Time': '2020-10-21T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 106692677, 'Time': '2021-02-09T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 111180486, 'Time': '2021-03-11T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 105609635, 'Time': '2020-11-24T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 102652157, 'Time': '2020-10-09T14:15:00', 'Type': 'Aftale'}, {'EncounterKey': 111127603, 'Time': '2021-02-25T10:00:00', 'Type': 'Aftale'}, {'EncounterKey': 111145382, 'Time': '2021-01-21T10:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 108989298, 'Time': '2021-01-07T11:00:00', 'Type': 'Ambulant besøg'}, {'EncounterKey': 102264811, 'Time': '2020-10-09T11:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111163862, 'Time': '2021-04-15T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106902509, 'Time': '2020-12-03T11:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111183166, 'Time': '2021-03-04T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111117620, 'Time': '2021-03-25T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 105505619, 'Time': '2020-11-18T09:30:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106674851, 'Time': '2021-02-02T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102676917, 'Time': '2020-10-09T14:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 105543808, 'Time': '2020-11-10T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106914332, 'Time': '2020-11-27T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102720906, 'Time': '2020-11-05T13:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102803602, 'Time': '2020-11-05T13:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102736688, 'Time': '2020-11-05T13:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 107970818, 'Time': '2020-12-15T12:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106702172, 'Time': '2020-12-15T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111120177, 'Time': '2021-02-11T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 112094929, 'Time': '2021-02-23T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111154120, 'Time': '2021-01-28T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111410769, 'Time': '2021-02-23T12:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111175815, 'Time': '2021-02-04T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 99937139, 'Time': '2020-09-06T00:00:00', 'Type': '3 Akut ambulant'}, {'EncounterKey': 130452149, 'Time': '2021-09-25T13:05:00', 'Type': '0 Indlagt'}, {'EncounterKey': 112100130, 'Time': '2021-03-02T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102651307, 'Time': '2020-11-10T13:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 103713334, 'Time': '2020-10-30T09:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 104314369, 'Time': '2020-11-05T11:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 107798724, 'Time': '2020-12-11T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 105702819, 'Time': '2020-11-20T09:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 105573406, 'Time': '2020-11-17T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 104512451, 'Time': '2020-11-06T09:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102562853, 'Time': '2020-10-20T12:30:00', 'Type': '2 Ambulant'}, {'EncounterKey': 104107768, 'Time': '2020-10-27T11:30:00', 'Type': '2 Ambulant'}, {'EncounterKey': 114153773, 'Time': '2021-03-09T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102742914, 'Time': '2020-11-05T13:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 1592171, 'Time': '2017-09-04T15:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102620759, 'Time': '2020-10-09T14:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111192552, 'Time': '2021-02-18T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 115329825, 'Time': '2021-03-23T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106662789, 'Time': '2021-02-16T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106656612, 'Time': '2021-01-12T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111155169, 'Time': '2021-04-08T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102679604, 'Time': '2020-10-09T14:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 109332593, 'Time': '2021-01-12T12:30:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106706377, 'Time': '2020-12-22T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111164118, 'Time': '2021-03-18T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106650668, 'Time': '2021-01-26T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106656474, 'Time': '2021-01-19T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106651705, 'Time': '2021-01-05T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 105612793, 'Time': '2020-11-19T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 99937698, 'Time': '2020-09-06T15:25:00', 'Type': '0 Indlagt'}, {'EncounterKey': 110487271, 'Time': '2021-01-19T12:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 103646158, 'Time': '2020-10-21T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 106692677, 'Time': '2021-02-09T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111180486, 'Time': '2021-03-11T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 105609635, 'Time': '2020-11-24T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102652157, 'Time': '2020-10-09T14:15:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111127603, 'Time': '2021-02-25T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 111145382, 'Time': '2021-01-21T10:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 108989298, 'Time': '2021-01-07T11:00:00', 'Type': '2 Ambulant'}, {'EncounterKey': 102264811, 'Time': '2020-10-08T00:00:00', 'Type': 'cancelled_government'}, {'EncounterKey': 111163862, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 111183166, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 111117620, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 102676917, 'Time': '2020-10-07T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 106914332, 'Time': '2020-11-27T00:00:00', 'Type': 'cancelled_government'}, {'EncounterKey': 102803602, 'Time': '2020-10-08T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 102736688, 'Time': '2020-10-08T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 111120177, 'Time': '2021-02-11T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 112100130, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 102651307, 'Time': '2020-11-03T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 102742914, 'Time': '2020-10-08T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 102620759, 'Time': '2020-10-07T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 111192552, 'Time': '2021-01-15T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 106662789, 'Time': '2021-01-27T00:00:00', 'Type': 'cancelled_government'}, {'EncounterKey': 111155169, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 102679604, 'Time': '2020-10-08T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 111164118, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 111180486, 'Time': '2021-02-23T00:00:00', 'Type': 'cancelled_patient'}, {'EncounterKey': 102652157, 'Time': '2020-10-07T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 111127603, 'Time': '2021-01-15T00:00:00', 'Type': 'cancelled_other'}, {'EncounterKey': 130452149, 'Time': '2021-09-25T00:00:00', 'Type': 'psych_admission'}, {'EncounterKey': 99937698, 'Time': '2020-09-06T00:00:00', 'Type': 'psych_admission'}, {'EncounterKey': 130452149, 'Time': '2021-09-27T11:35:00', 'Type': 'psych_discharge'}, {'EncounterKey': 99937698, 'Time': '2020-10-09T16:00:00', 'Type': 'psych_discharge'}, {'EncounterKey': 99937698, 'Time': '2020-09-06', 'Type': 'DF32_33'}, {'EncounterKey': 105573406, 'Time': '2020-11-17', 'Type': 'DF32_33'}, {'EncounterKey': 106702172, 'Time': '2020-12-15', 'Type': 'DF32_33'}, {'EncounterKey': 107970818, 'Time': '2020-12-15', 'Type': 'DF32_33'}, {'EncounterKey': 105702819, 'Time': '2020-11-20', 'Type': 'DF32_33'}, {'EncounterKey': 105505619, 'Time': '2020-11-18', 'Type': 'DF32_33'}, {'EncounterKey': 107606035, 'Time': '2020-11-30', 'Type': 'DF32_33'}, {'EncounterKey': 99937698, 'Time': '2020-09-09', 'Type': 'DF32_33'}, {'EncounterKey': 99937698, 'Time': '2020-09-06', 'Type': 'DF32_33'}, {'EncounterKey': 99937698, 'Time': '2020-09-09', 'Type': 'DF32_33'}, {'EncounterKey': 105543808, 'Time': '2020-11-10', 'Type': 'DF32_33'}, {'EncounterKey': 106706377, 'Time': '2020-12-22', 'Type': 'DF32_33'}, {'EncounterKey': 107798724, 'Time': '2020-12-11', 'Type': 'DF32_33'}, {'EncounterKey': 105609635, 'Time': '2020-11-24', 'Type': 'DF32_33'}, {'EncounterKey': 104314369, 'Time': '2020-11-05', 'Type': 'DF32_33'}, {'EncounterKey': 105612793, 'Time': '2020-11-19', 'Type': 'DF32_33'}, {'EncounterKey': 107364124, 'Time': '2020-11-26', 'Type': 'DF32_33'}, {'EncounterKey': 102562853, 'Time': '2020-10-20', 'Type': 'DF32_33'}, {'EncounterKey': 103646158, 'Time': '2020-10-21', 'Type': 'DF32_33'}, {'EncounterKey': 107468172, 'Time': '2020-11-27', 'Type': 'DF32_33'}, {'EncounterKey': 104107768, 'Time': '2020-10-27', 'Type': 'DF32_33'}, {'EncounterKey': 103713334, 'Time': '2020-10-30', 'Type': 'DF32_33'}, {'EncounterKey': 107785067, 'Time': '2020-12-01', 'Type': 'DF32_33'}, {'EncounterKey': 108675000, 'Time': '2020-12-18', 'Type': 'DF32_33'}, {'EncounterKey': 106902509, 'Time': '2020-12-03', 'Type': 'DF32_33'}, {'EncounterKey': 104512451, 'Time': '2020-11-06', 'Type': 'DF32_33'}, {'EncounterKey': 106656612, 'Time': '2021-01-12', 'Type': 'DF32_33'}, {'EncounterKey': 109332593, 'Time': '2021-01-12', 'Type': 'DF32_33'}, {'EncounterKey': 130452149, 'Time': '2021-09-25', 'Type': 'DF32_33'}, {'EncounterKey': 111145382, 'Time': '2021-01-21', 'Type': 'DF32_33'}, {'EncounterKey': 111410769, 'Time': '2021-02-23', 'Type': 'DF32_33'}, {'EncounterKey': 111175815, 'Time': '2021-02-04', 'Type': 'DF32_33'}, {'EncounterKey': 110487271, 'Time': '2021-01-19', 'Type': 'DF32_33'}, {'EncounterKey': 106656474, 'Time': '2021-01-19', 'Type': 'DF32_33'}, {'EncounterKey': 106650668, 'Time': '2021-01-26', 'Type': 'DF32_33'}, {'EncounterKey': 111103479, 'Time': '2021-01-15', 'Type': 'DF32_33'}, {'EncounterKey': 106692677, 'Time': '2021-02-09', 'Type': 'DF32_33'}, {'EncounterKey': 114153773, 'Time': '2021-03-09', 'Type': 'DF32_33'}, {'EncounterKey': 106674851, 'Time': '2021-02-02', 'Type': 'DF32_33'}, {'EncounterKey': 130452149, 'Time': '2021-09-25', 'Type': 'DF32_33'}, {'EncounterKey': 115329825, 'Time': '2021-03-23', 'Type': 'DF32_33'}, {'EncounterKey': 111671489, 'Time': '2021-01-22', 'Type': 'DF32_33'}, {'EncounterKey': 108989298, 'Time': '2021-01-07', 'Type': 'DF32_33'}, {'EncounterKey': 111154120, 'Time': '2021-01-28', 'Type': 'DF32_33'}, {'EncounterKey': 112094929, 'Time': '2021-02-23', 'Type': 'DF32_33'}, {'EncounterKey': 106651705, 'Time': '2021-01-05', 'Type': 'DF32_33'}, {'EncounterKey': 99937698, 'Time': '2020-09-06', 'Type': 'DF3'}, {'EncounterKey': 105573406, 'Time': '2020-11-17', 'Type': 'DF3'}, {'EncounterKey': 106702172, 'Time': '2020-12-15', 'Type': 'DF3'}, {'EncounterKey': 107970818, 'Time': '2020-12-15', 'Type': 'DF3'}, {'EncounterKey': 105702819, 'Time': '2020-11-20', 'Type': 'DF3'}, {'EncounterKey': 105505619, 'Time': '2020-11-18', 'Type': 'DF3'}, {'EncounterKey': 107606035, 'Time': '2020-11-30', 'Type': 'DF3'}, {'EncounterKey': 99937698, 'Time': '2020-09-09', 'Type': 'DF3'}, {'EncounterKey': 99937698, 'Time': '2020-09-06', 'Type': 'DF3'}, {'EncounterKey': 99937698, 'Time': '2020-09-09', 'Type': 'DF3'}, {'EncounterKey': 105543808, 'Time': '2020-11-10', 'Type': 'DF3'}, {'EncounterKey': 106706377, 'Time': '2020-12-22', 'Type': 'DF3'}, {'EncounterKey': 107798724, 'Time': '2020-12-11', 'Type': 'DF3'}, {'EncounterKey': 105609635, 'Time': '2020-11-24', 'Type': 'DF3'}, {'EncounterKey': 104314369, 'Time': '2020-11-05', 'Type': 'DF3'}, {'EncounterKey': 105612793, 'Time': '2020-11-19', 'Type': 'DF3'}, {'EncounterKey': 107364124, 'Time': '2020-11-26', 'Type': 'DF3'}, {'EncounterKey': 102562853, 'Time': '2020-10-20', 'Type': 'DF3'}, {'EncounterKey': 103646158, 'Time': '2020-10-21', 'Type': 'DF3'}, {'EncounterKey': 107468172, 'Time': '2020-11-27', 'Type': 'DF3'}, {'EncounterKey': 104107768, 'Time': '2020-10-27', 'Type': 'DF3'}, {'EncounterKey': 103713334, 'Time': '2020-10-30', 'Type': 'DF3'}, {'EncounterKey': 107785067, 'Time': '2020-12-01', 'Type': 'DF3'}, {'EncounterKey': 108675000, 'Time': '2020-12-18', 'Type': 'DF3'}, {'EncounterKey': 106902509, 'Time': '2020-12-03', 'Type': 'DF3'}, {'EncounterKey': 104512451, 'Time': '2020-11-06', 'Type': 'DF3'}, {'EncounterKey': 106656612, 'Time': '2021-01-12', 'Type': 'DF3'}, {'EncounterKey': 109332593, 'Time': '2021-01-12', 'Type': 'DF3'}, {'EncounterKey': 130452149, 'Time': '2021-09-25', 'Type': 'DF3'}, {'EncounterKey': 111145382, 'Time': '2021-01-21', 'Type': 'DF3'}, {'EncounterKey': 111410769, 'Time': '2021-02-23', 'Type': 'DF3'}, {'EncounterKey': 111175815, 'Time': '2021-02-04', 'Type': 'DF3'}, {'EncounterKey': 110487271, 'Time': '2021-01-19', 'Type': 'DF3'}, {'EncounterKey': 106656474, 'Time': '2021-01-19', 'Type': 'DF3'}, {'EncounterKey': 106650668, 'Time': '2021-01-26', 'Type': 'DF3'}, {'EncounterKey': 111103479, 'Time': '2021-01-15', 'Type': 'DF3'}, {'EncounterKey': 106692677, 'Time': '2021-02-09', 'Type': 'DF3'}, {'EncounterKey': 114153773, 'Time': '2021-03-09', 'Type': 'DF3'}, {'EncounterKey': 106674851, 'Time': '2021-02-02', 'Type': 'DF3'}, {'EncounterKey': 130452149, 'Time': '2021-09-25', 'Type': 'DF3'}, {'EncounterKey': 115329825, 'Time': '2021-03-23', 'Type': 'DF3'}, {'EncounterKey': 111671489, 'Time': '2021-01-22', 'Type': 'DF3'}, {'EncounterKey': 108989298, 'Time': '2021-01-07', 'Type': 'DF3'}, {'EncounterKey': 111154120, 'Time': '2021-01-28', 'Type': 'DF3'}, {'EncounterKey': 112094929, 'Time': '2021-02-23', 'Type': 'DF3'}, {'EncounterKey': 106651705, 'Time': '2021-01-05', 'Type': 'DF3'}], 'Coercion': []})\n"
        },
        {
          "output_type": "stream",
          "name": "stderr",
          "text": "Vocab: 100%|██████████| 5818/5818 [00:00<00:00, 20296.80it/s]\n"
        }
      ],
      "execution_count": 3,
      "metadata": {
        "gather": {
          "logged": 1690626119322
        }
      }
    },
    {
      "cell_type": "code",
      "source": [
        "# Data loader\r\n",
        "data = process_data_CoercionRisk(\r\n",
        "    data_json, vocab_list, word_to_idx, mask_prob=0.20, Azure=Azure\r\n",
        ")\r\n",
        "sample_data = CoercionRiskDataset(data)\r\n",
        "sample = next(iter(sample_data))"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stderr",
          "text": " 17%|█▋        | 1001/5818 [00:21<01:41, 47.33it/s]\n"
        }
      ],
      "execution_count": 4,
      "metadata": {
        "gather": {
          "logged": 1690626140758
        }
      }
    },
    {
      "cell_type": "code",
      "source": [
        "import itertools\r\n",
        "\r\n",
        "# sample = next(iter(data.items()))\r\n",
        "\r\n",
        "# Replace 'N' with the desired item number you want to access (in this case, 10)\r\n",
        "item_number = 10\r\n",
        "\r\n",
        "# Using itertools.islice to get the Nth item (key-value pair) from the dictionary\r\n",
        "# sample = next(itertools.islice(data.items(), item_number))\r\n",
        "\r\n",
        "count  = 0\r\n",
        "for sample in data.items():\r\n",
        "    index = sample[1]['sample_index']\r\n",
        "    if sample[1]['classification_labels'] == 1:\r\n",
        "        print('patient',sample[1]['patient'])\r\n",
        "        print('date',sample[1]['dates'][index-5:index+10])\r\n",
        "        print('age',sample[1]['age'][index-5:index+10])\r\n",
        "        print('codes',sample[1]['codes'][index-5:index+10])\r\n",
        "        print('position',sample[1]['position'][index-5:index+10])\r\n",
        "        print('segment',sample[1]['segment'][index-5:index+10])\r\n",
        "        print('classification_labels',sample[1]['classification_labels'])\r\n",
        "        print('original_code_sequence',sample[1]['original_code_sequence'][index-5:index+50])\r\n",
        "        print('sample_index',sample[1]['sample_index'])\r\n",
        "        print('input_sequence',sample[1]['input_sequence'][index-5:index+10])\r\n",
        "        print('attention_mask',sample[1]['attention_mask'][index-5:index+10])\r\n",
        "        break\r\n",
        "    count +=1\r\n",
        "\r\n",
        "\r\n"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "patient 36139\ndate []\nage []\ncodes []\nposition []\nsegment []\nclassification_labels 1\noriginal_code_sequence ['<SEP>', 'Behandlingskontakt', '3 Akut ambulant', '<SEP>', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_start', 'coercion_3_end', 'coercion_3_end', 'coercion_3_end', 'psych_admission', 'coercion_Bælte', 'coercion_Beroligende medicin', 'coercion_Bælte', 'coercion_Tvangsindlæggelse', 'coercion_Beroligende medicin', 'coercion_Tvangsindlæggelse', 'coercion_Beroligende medicin', 'coercion_Bælte', 'coercion_Tvangsindlæggelse', 'Behandlingskontakt', '0 Indlagt', 'coercion_1_start', 'coercion_1_start', 'coercion_1_start', 'coercion_1_end', 'psych_discharge', '<SEP>', 'cancelled_reschedule', 'Aftale', '2 Ambulant', '<SEP>', 'DF44_49', 'DF40_43', 'DF4', 'DF4', 'Telefonkontakt', '2 Ambulant', '<SEP>', 'DF40_43', 'DF4', '<SEP>', 'DF40_43', 'DF4', 'Telefonkontakt', '2 Ambulant', '<SEP>', 'DF40_43', 'DF4']\nsample_index 1572\ninput_sequence []\nattention_mask []\n"
        }
      ],
      "execution_count": 9,
      "metadata": {
        "jupyter": {
          "source_hidden": false,
          "outputs_hidden": false
        },
        "nteract": {
          "transient": {
            "deleting": false
          }
        },
        "gather": {
          "logged": 1690626385967
        }
      }
    },
    {
      "cell_type": "code",
      "source": [
        "sample[1]['dates']"
      ],
      "outputs": [
        {
          "output_type": "execute_result",
          "execution_count": 11,
          "data": {
            "text/plain": "[43829,\n 43838,\n 43838,\n 43838,\n 43838,\n 43838,\n 43838,\n 43838,\n 43840,\n 43841,\n 43841,\n 43842,\n 43842,\n 43843,\n 43843,\n 43843,\n 43843,\n 43848,\n 43848,\n 43850,\n 43850,\n 43851,\n 43851,\n 43856,\n 43856,\n 43856,\n 43856,\n 43856,\n 43856,\n 43858,\n 43858,\n 43858,\n 43858,\n 43859,\n 43859,\n 43862,\n 43862,\n 43861,\n 43861,\n 43862,\n 43862,\n 43862,\n 43862,\n 43863,\n 43863,\n 43865,\n 43865,\n 43865,\n 43865,\n 43865,\n 43865,\n 43868,\n 43868,\n 43869,\n 43869,\n 43869,\n 43869,\n 43870,\n 43870,\n 43871,\n 43871,\n 43871,\n 43871,\n 43872,\n 43872,\n 43872,\n 43872,\n 43872,\n 43872,\n 43873,\n 43873,\n 43873,\n 43873,\n 43873,\n 43873,\n 43873,\n 43873,\n 43873,\n 43873,\n 43876,\n 43876,\n 43876,\n 43876,\n 43877,\n 43883,\n 43883,\n 43879,\n 43879,\n 43879,\n 43879,\n 43879,\n 43879,\n 43883,\n 43883,\n 43883,\n 43883,\n 43884,\n 43884,\n 43884,\n 43884,\n 43892,\n 43892,\n 43892,\n 43892,\n 43893,\n 43894,\n 43894,\n 43894,\n 43894,\n 43898,\n 43898,\n 43900,\n 43900,\n 43901,\n 43901,\n 43901,\n 43901,\n 43904,\n 43904,\n 43904,\n 43904,\n 43905,\n 43905,\n 43905,\n 43905,\n 43906,\n 43906,\n 43906,\n 43906,\n 43907,\n 43907,\n 43907,\n 43907,\n 43907,\n 43907,\n 43907,\n 43907,\n 43908,\n 43908,\n 43908,\n 43908,\n 43908,\n 43908,\n 43911,\n 43911,\n 43911,\n 43911,\n 43913,\n 43913,\n 43913,\n 43913,\n 43914,\n 43914,\n 43916,\n 43916,\n 43917,\n 43917,\n 43917,\n 43917,\n 43918,\n 43918,\n 43918,\n 43918,\n 43919,\n 43919,\n 43919,\n 43919,\n 43919,\n 43919,\n 43919,\n 43919,\n 43919,\n 43919,\n 43920,\n 43920,\n 43920,\n 43920,\n 43920,\n 43920,\n 43921,\n 43921,\n 43921,\n 43921,\n 43921,\n 43922,\n 43922,\n 43922,\n 43926,\n 43926,\n 43926,\n 43926,\n 43933,\n 43933,\n 43933,\n 43933,\n 43935,\n 43935,\n 43935,\n 43935,\n 43936,\n 43936,\n 43939,\n 43939,\n 43939,\n 43939,\n 43940,\n 43940,\n 43942,\n 43942,\n 43942,\n 43942,\n 43942,\n 43942,\n 43947,\n 43947,\n 43947,\n 43947,\n 43947,\n 43947,\n 43947,\n 43947,\n 43948,\n 43948,\n 43949,\n 43949,\n 43949,\n 43949,\n 43953,\n 43953,\n 43955,\n 43955,\n 43955,\n 43955,\n 43963,\n 43963,\n 43963,\n 43963,\n 43963,\n 43996,\n 43996,\n 43965,\n 43965,\n 43967,\n 43967,\n 43967,\n 43967,\n 43969,\n 43969,\n 43974,\n 43974,\n 43977,\n 43977,\n 43977,\n 43977,\n 43978,\n 43978,\n 43978,\n 43978,\n 43982,\n 43982,\n 43985,\n 44017,\n 44017,\n 43985,\n 43985,\n 43985,\n 43985,\n 44038,\n 44038,\n 43992,\n 43992,\n 43992,\n 43992,\n 43998,\n 43998,\n 43999,\n 43999,\n 43999,\n 43999,\n 44006,\n 44006,\n 44010,\n 44010,\n 44010,\n 44010,\n 44016,\n 44016,\n 44018,\n 44018,\n 44025,\n 44025,\n 44025,\n 44025,\n 44032,\n 44032,\n 44032,\n 44032,\n 44038,\n 44038,\n 44038,\n 44039,\n 44039,\n 44040,\n 44040,\n 44051,\n 44051,\n 44051,\n 44051,\n 44052,\n 44052,\n 44052,\n 44052,\n 44058,\n 44058,\n 44061,\n 44061,\n 44061,\n 44061,\n 44063,\n 44063,\n 44063,\n 44063,\n 44065,\n 44065,\n 44065,\n 44065,\n 44065,\n 44066,\n 44066,\n 44068,\n 44068,\n 44068,\n 44068,\n 44073,\n 44073,\n 44076,\n 44076,\n 44077,\n 44077,\n 44088,\n 44088,\n 44088,\n 44088,\n 44095,\n 44095,\n 44100,\n 44100,\n 44102,\n 44102,\n 44103,\n 44103,\n 44103,\n 44103,\n 44104,\n 44104,\n 44104,\n 44104,\n 44107,\n 44107,\n 44107,\n 44107,\n 44109,\n 44109,\n 44109,\n 44109,\n 44109,\n 44109,\n 44118,\n 44118,\n 44118,\n 44118,\n 44121,\n 44121,\n 44121,\n 44121,\n 44129,\n 44129,\n 44129,\n 44129,\n 44132,\n 44132,\n 44135,\n 44145,\n 44145,\n 44158,\n 44158,\n 44163,\n 44163,\n 44163,\n 44163,\n 44165,\n 44165,\n 44170,\n 44170,\n 44172,\n 44172,\n 44174,\n 44174,\n 44174,\n 44174,\n 44176,\n 44176,\n 44177,\n 44177,\n 44177,\n 44178,\n 44187,\n 44187,\n 44188,\n 44213,\n 44213,\n 44206,\n 44206,\n 44206,\n 44206,\n 44233,\n 44233,\n 44238,\n 44238,\n 44239,\n 44239,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44248,\n 44249,\n 44249,\n 44249,\n 44271,\n 44271,\n 44275,\n 44304,\n 44304,\n 44298,\n 44298,\n 44298,\n 44298,\n 44298,\n 44298,\n 44304,\n 44304,\n 44332,\n 44332,\n 44332,\n 44332,\n 44332,\n 44332,\n 44332,\n 44332,\n 44341,\n 44341,\n 44341,\n 44341,\n 44341,\n 44341,\n 44382,\n 44425,\n 44425,\n 44388,\n 44493,\n 44493,\n 44424,\n 44424,\n 44429,\n 44429,\n 44429,\n 44429,\n 44430,\n 44430,\n 44432,\n 44432,\n 44451,\n 44451,\n 44464,\n 44464,\n 44464,\n 44464,\n 44465,\n 44465,\n 44468,\n 44468,\n 44473,\n 44473,\n 44483,\n 44483,\n 44483,\n 44483,\n 44493,\n 44493,\n 44493,\n 44493,\n 44553]"
          },
          "metadata": {}
        }
      ],
      "execution_count": 11,
      "metadata": {
        "jupyter": {
          "source_hidden": false,
          "outputs_hidden": false
        },
        "nteract": {
          "transient": {
            "deleting": false
          }
        },
        "gather": {
          "logged": 1690626756699
        }
      }
    },
    {
      "cell_type": "code",
      "source": [],
      "outputs": [],
      "execution_count": null,
      "metadata": {
        "jupyter": {
          "source_hidden": false,
          "outputs_hidden": false
        },
        "nteract": {
          "transient": {
            "deleting": false
          }
        }
      }
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python38-azureml",
      "language": "python",
      "display_name": "Python 3.8 - AzureML"
    },
    "language_info": {
      "name": "python",
      "version": "3.8.5",
      "mimetype": "text/x-python",
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "pygments_lexer": "ipython3",
      "nbconvert_exporter": "python",
      "file_extension": ".py"
    },
    "orig_nbformat": 4,
    "microsoft": {
      "ms_spell_check": {
        "ms_spell_check_language": "en"
      },
      "host": {
        "AzureML": {
          "notebookHasBeenCompleted": true
        }
      }
    },
    "kernel_info": {
      "name": "python38-azureml"
    },
    "nteract": {
      "version": "nteract-front-end@1.0.0"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 2
}